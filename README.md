# OLKB Planck Oryx Converter

This repository contains tools to convert ZSA Oryx source code to firmware compatible with the OLKB Planck Rev 6 (and 6.1) keyboard, with full **Vial** support.

## Problem Statement
The OLKB Planck Rev 6 uses a "folded" electrical matrix (8 rows x 6 columns) which is fundamentally different from the visual 4x12 grid layout. ZSA Oryx exports code assuming a linear 4x12 layout, which causes keys to be scrambled when flashed directly to an OLKB board. Additionally, standard ZSA exports lack the necessary configuration for Vial (dynamic remapping).

## Solution
The script `scripts/oryx_to_olkb.py` automatically:
1. **Transposes the Matrix**: Splits the 4x12 visual grid into two 4x6 halves and maps them to the correct Planck Rev 6 matrix rows.
2. **Preserves Logic**: Retains your macros, tap dances, and custom keycodes from the Oryx export.
3. **Enables Vial**: Generates `rules.mk` and `config.h` with the required settings (`VIAL_ENABLE`, `VIAL_KEYBOARD_UID`, unlock combos) to make the keyboard detected by the Vial app.
4. **Fixes Conflicts**: 
   - Automatically disables `matrix_scan_user` to prevent conflicts with Vial.
   - Wraps `tap_dance_actions` in preprocessor guards so Vial can take ownership when enabled.
   - Disables conflicting features (`LTO`, `COMBO`, `KEY_OVERRIDE`) to ensure successful compilation.
5. **Generates Vial Definition**: Creates a `vial.json` file for manual sideloading if auto-detection fails.

## Usage

1. **Export from Oryx**: Download the source code for your layout from ZSA Oryx.
2. **Place Source**: Copy the `keymap.c` file from the download into the `zsa_oryx_source/` folder.
3. **Run Script**:
   ```bash
   python3 scripts/oryx_to_olkb.py
   ```
4. **Deploy**: The script generates **4 files** in `olkb_firmware/`:
   - `keymap.c` (Converted keymap)
   - `rules.mk` (Build rules with Vial & Audio enabled, LTO disabled)
   - `config.h` (Vial configuration with UID and Unlock Combo)
   - `vial.json` (Vial layout definition)

   Copy **all files** to your QMK directory:
   ```bash
   cp olkb_firmware/* qmk_firmware/keyboards/planck/keymaps/vial/
   ```

5. **Compile**:
   ```bash
   qmk compile -kb planck/rev6 -km vial
   ```

6. **Flash**: Use QMK Toolbox or the command line to flash the resulting `.bin` file.

## Troubleshooting & Vial Recognition

### Vial Doesn't Recognize the Keyboard
Because this uses a custom `VIAL_KEYBOARD_UID`, the Vial app might not automatically download the layout definition.
1. Open the Vial desktop app.
2. Go to **File > Sideload Keyboard JSON...**.
3. Select the `vial.json` file generated by the script (located in `olkb_firmware/vial.json` or your keymap folder).
4. The keyboard should now appear.

### Tap Dances Not Working
The script wraps your custom tap dances in `#ifndef VIAL_ENABLE`. This allows Vial to manage tap dances if you configure them in the GUI. 
- If you want to use your **original ZSA tap dances**, you may need to disable `VIAL_TAP_DANCE_ENABLE` in `rules.mk` (already done by default) and ensure the `#ifndef` guard allows your code to run.
- **Test**: Try your tap dance keys. If they don't work, verify that `tap_dance_actions` is being compiled in.

### Clearing EEPROM
If weird behavior persists (keys mapped wrong, layers acting up):
1. Unplug the keyboard.
2. Hold **Space** + **Backspace** (or the top-left and top-right physical keys if mapped differently).
3. Plug the keyboard in while holding them.
4. Wait 5 seconds, then release. This resets the persistent memory.

## Features Status
- **Matrix Transposition**: ✅ Working (8x6 mapped)
- **Vial Support**: ✅ Enabled (UID: `{0x89...0x77}`)
- **Audio**: ✅ Enabled (`AUDIO_ENABLE = yes`, `MUSIC_ENABLE = yes`)
- **Optimization**: ⚠️ `LTO_ENABLE` disabled to prevent linker errors with Vial.
- **Introspection**: ⚠️ `COMBO_ENABLE` and `KEY_OVERRIDE_ENABLE` disabled to prevent conflicts.
